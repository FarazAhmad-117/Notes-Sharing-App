# üî• Notes Sharing App - Firebase Architecture

> **Firebase setup, data models, security rules, and integration patterns**

---

## üìë Table of Contents

1. [Firebase Project Setup](#firebase-project-setup)
2. [Firestore Database Schema](#firestore-database-schema)
3. [Security Rules](#security-rules)
4. [Storage Rules](#storage-rules)
5. [Authentication Flow](#authentication-flow)
6. [Real-time Listeners](#real-time-listeners)
7. [Cloud Messaging Setup](#cloud-messaging-setup)

---

## üéØ Firebase Project Setup

### Firebase Services Used

```
Firebase Project: notes-sharing-app
‚îÇ
‚îú‚îÄ‚îÄ Authentication
‚îÇ   ‚îî‚îÄ‚îÄ Email/Password (enabled)
‚îÇ
‚îú‚îÄ‚îÄ Firestore Database
‚îÇ   ‚îú‚îÄ‚îÄ users/
‚îÇ   ‚îú‚îÄ‚îÄ notes/
‚îÇ   ‚îú‚îÄ‚îÄ shared_notes/
‚îÇ   ‚îú‚îÄ‚îÄ messages/
‚îÇ   ‚îî‚îÄ‚îÄ notifications/
‚îÇ
‚îú‚îÄ‚îÄ Cloud Storage (Optional - using Cloudinary instead)
‚îÇ
‚îî‚îÄ‚îÄ Cloud Messaging (FCM)
    ‚îî‚îÄ‚îÄ Push notifications
```

### Firebase Configuration

**Files Required:**

- `android/app/google-services.json` (Android)
- `ios/Runner/GoogleService-Info.plist` (iOS)
- `lib/firebase_options.dart` (Generated by FlutterFire CLI)

**Setup Steps:**

1. Create Firebase project in Firebase Console
2. Add Android app (package name: `com.example.notes_sharing_app`)
3. Add iOS app (bundle ID: `com.example.notesSharingApp`)
4. Run `flutterfire configure` to generate `firebase_options.dart`
5. Enable Authentication (Email/Password)
6. Create Firestore database (start in test mode)
7. Setup security rules (see below)

---

## üìä Firestore Database Schema

### Collection Structure

```
firestore/
‚îú‚îÄ‚îÄ users/{userId}
‚îú‚îÄ‚îÄ notes/{noteId}
‚îú‚îÄ‚îÄ shared_notes/{sharedNoteId}
‚îú‚îÄ‚îÄ messages/{messageId}
‚îî‚îÄ‚îÄ notifications/{userId}/items/{notificationId}
```

---

### 1. `users` Collection

**Path:** `users/{userId}`

**Document Structure:**

```javascript
{
  // User identification
  uid: string,              // Firebase Auth UID (same as document ID)
  email: string,
  displayName: string,
  photoUrl: string?,

  // User metadata
  fcmToken: string?,        // For push notifications
  isEmailVerified: boolean,

  // App-specific
  createdAt: Timestamp,
  updatedAt: Timestamp,
  lastSeen: Timestamp?,

  // Preferences (optional)
  theme: 'light' | 'dark' | 'system',
  language: string,
}
```

**Example:**

```javascript
{
  uid: "abc123",
  email: "user@example.com",
  displayName: "John Doe",
  photoUrl: "https://cloudinary.com/...",
  fcmToken: "fcm_token_here",
  isEmailVerified: true,
  createdAt: Timestamp(2024, 12, 1),
  updatedAt: Timestamp(2024, 12, 1),
  lastSeen: Timestamp(2024, 12, 1),
  theme: "system",
  language: "en"
}
```

---

### 2. `notes` Collection

**Path:** `notes/{noteId}`

**Document Structure:**

```javascript
{
  // Note identification
  id: string,               // Same as document ID
  userId: string,           // Owner's UID

  // Note content
  title: string,
  content: string,          // Rich text or markdown
  category: string?,       // Optional category/tag
  tags: string[],          // Array of tags

  // Media
  images: string[],        // Array of Cloudinary URLs
  attachments: string[],   // Array of file URLs

  // Metadata
  isPinned: boolean,
  color: string?,          // Optional note color
  isArchived: boolean,

  // PDF
  pdfUrl: string?,         // If PDF was generated
  hasPdf: boolean,

  // Timestamps
  createdAt: Timestamp,
  updatedAt: Timestamp,
  lastAccessedAt: Timestamp?,

  // Sharing
  isShared: boolean,       // Whether note is shared
  sharedWithCount: number, // Count of users shared with
}
```

**Example:**

```javascript
{
  id: "note123",
  userId: "abc123",
  title: "Meeting Notes",
  content: "# Meeting Notes\n\n- Discussed project timeline",
  category: "work",
  tags: ["meeting", "project"],
  images: [
    "https://res.cloudinary.com/.../image1.jpg",
    "https://res.cloudinary.com/.../image2.jpg"
  ],
  attachments: [],
  isPinned: false,
  color: "#FF5733",
  isArchived: false,
  pdfUrl: "https://res.cloudinary.com/.../note123.pdf",
  hasPdf: true,
  createdAt: Timestamp(2024, 12, 1, 10, 0),
  updatedAt: Timestamp(2024, 12, 1, 15, 30),
  lastAccessedAt: Timestamp(2024, 12, 1, 15, 30),
  isShared: true,
  sharedWithCount: 3
}
```

**Indexes Required:**

- `userId` + `createdAt` (descending)
- `userId` + `updatedAt` (descending)
- `userId` + `isArchived` + `createdAt`
- `userId` + `category` + `createdAt`

---

### 3. `shared_notes` Collection

**Path:** `shared_notes/{sharedNoteId}`

**Document Structure:**

```javascript
{
  // Sharing identification
  id: string,               // Same as document ID
  noteId: string,          // Reference to notes collection
  ownerId: string,         // Note owner's UID
  sharedWithId: string,    // User who note is shared with

  // Permissions
  permission: 'view' | 'edit',  // Access level

  // Denormalized data (for quick access)
  noteTitle: string,
  noteContent: string,     // Preview or full content
  ownerName: string,
  ownerEmail: string,

  // Status
  isAccepted: boolean,     // Whether user accepted the share
  isActive: boolean,       // Whether sharing is still active

  // Timestamps
  sharedAt: Timestamp,
  acceptedAt: Timestamp?,
  lastAccessedAt: Timestamp?,
}
```

**Example:**

```javascript
{
  id: "share123",
  noteId: "note123",
  ownerId: "abc123",
  sharedWithId: "xyz789",
  permission: "edit",
  noteTitle: "Meeting Notes",
  noteContent: "# Meeting Notes\n\n- Discussed...",
  ownerName: "John Doe",
  ownerEmail: "john@example.com",
  isAccepted: true,
  isActive: true,
  sharedAt: Timestamp(2024, 12, 1, 12, 0),
  acceptedAt: Timestamp(2024, 12, 1, 12, 5),
  lastAccessedAt: Timestamp(2024, 12, 1, 14, 0)
}
```

**Indexes Required:**

- `sharedWithId` + `isActive` + `sharedAt` (descending)
- `ownerId` + `isActive` + `sharedAt` (descending)
- `noteId` + `isActive`

---

### 4. `messages` Collection

**Path:** `messages/{messageId}`

**Document Structure:**

```javascript
{
  // Message identification
  id: string,               // Same as document ID
  noteId: string,          // Related note (if applicable)

  // Participants
  senderId: string,        // Sender's UID
  receiverId: string,      // Receiver's UID

  // Message content
  text: string,
  type: 'text' | 'image' | 'file',
  mediaUrl: string?,       // For images/files

  // Status
  isRead: boolean,
  readAt: Timestamp?,

  // Timestamps
  createdAt: Timestamp,
}
```

**Example:**

```javascript
{
  id: "msg123",
  noteId: "note123",
  senderId: "abc123",
  receiverId: "xyz789",
  text: "Can you review this note?",
  type: "text",
  mediaUrl: null,
  isRead: false,
  readAt: null,
  createdAt: Timestamp(2024, 12, 1, 13, 0)
}
```

**Indexes Required:**

- `receiverId` + `isRead` + `createdAt` (descending)
- `senderId` + `createdAt` (descending)
- `noteId` + `createdAt` (descending)

**Alternative Structure (Subcollection):**
For better organization, messages can be stored as:

```
messages/{conversationId}/items/{messageId}
```

Where `conversationId` is a combination of sorted user IDs: `userId1_userId2`

---

### 5. `notifications` Collection

**Path:** `notifications/{userId}/items/{notificationId}`

**Document Structure:**

```javascript
{
  // Notification identification
  id: string,               // Same as document ID
  userId: string,          // Target user (same as parent)

  // Notification content
  title: string,
  body: string,
  type: 'note_shared' | 'note_updated' | 'message_received' | 'pdf_generated',

  // Related data
  relatedId: string?,      // noteId, messageId, etc.
  relatedType: string?,    // 'note', 'message', etc.

  // Status
  isRead: boolean,
  readAt: Timestamp?,

  // Action
  actionUrl: string?,      // Deep link or route

  // Timestamps
  createdAt: Timestamp,
}
```

**Example:**

```javascript
{
  id: "notif123",
  userId: "xyz789",
  title: "New Note Shared",
  body: "John Doe shared 'Meeting Notes' with you",
  type: "note_shared",
  relatedId: "note123",
  relatedType: "note",
  isRead: false,
  readAt: null,
  actionUrl: "/notes/note123",
  createdAt: Timestamp(2024, 12, 1, 12, 0)
}
```

---

## üîí Security Rules

### Firestore Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Users collection
    match /users/{userId} {
      allow read: if isOwner(userId) || isAuthenticated(); // Can read own or any (for sharing)
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if false; // Users cannot delete themselves
    }

    // Notes collection
    match /notes/{noteId} {
      // Read: owner or users with shared access
      allow read: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        exists(/databases/$(database)/documents/shared_notes/$(noteId + '_' + request.auth.uid))
      );

      // Create: authenticated users
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;

      // Update: owner or users with edit permission
      allow update: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        (exists(/databases/$(database)/documents/shared_notes/$(noteId + '_' + request.auth.uid)) &&
         get(/databases/$(database)/documents/shared_notes/$(noteId + '_' + request.auth.uid)).data.permission == 'edit')
      );

      // Delete: only owner
      allow delete: if isOwner(resource.data.userId);
    }

    // Shared notes collection
    match /shared_notes/{sharedNoteId} {
      // Read: owner or shared user
      allow read: if isAuthenticated() && (
        isOwner(resource.data.ownerId) ||
        isOwner(resource.data.sharedWithId)
      );

      // Create: authenticated users (sharing their notes)
      allow create: if isAuthenticated() &&
                       request.resource.data.ownerId == request.auth.uid;

      // Update: owner or shared user (for acceptance)
      allow update: if isAuthenticated() && (
        isOwner(resource.data.ownerId) ||
        isOwner(resource.data.sharedWithId)
      );

      // Delete: owner
      allow delete: if isOwner(resource.data.ownerId);
    }

    // Messages collection
    match /messages/{messageId} {
      // Read: sender or receiver
      allow read: if isAuthenticated() && (
        isOwner(resource.data.senderId) ||
        isOwner(resource.data.receiverId)
      );

      // Create: authenticated users
      allow create: if isAuthenticated() &&
                       request.resource.data.senderId == request.auth.uid;

      // Update: receiver (mark as read)
      allow update: if isAuthenticated() &&
                       isOwner(resource.data.receiverId) &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead', 'readAt']);

      // Delete: sender or receiver
      allow delete: if isAuthenticated() && (
        isOwner(resource.data.senderId) ||
        isOwner(resource.data.receiverId)
      );
    }

    // Notifications collection
    match /notifications/{userId}/items/{notificationId} {
      // Read/Write: only the notification owner
      allow read, write: if isAuthenticated() && isOwner(userId);
    }
  }
}
```

### Storage Rules (If using Firebase Storage)

```javascript
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // User profile images
    match /user_profiles/{userId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Note attachments (if not using Cloudinary)
    match /note_attachments/{userId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
```

---

## üîê Authentication Flow

### Sign Up Flow

```dart
1. User enters email and password
2. Create user with Firebase Auth
3. Send email verification
4. Create user document in Firestore (users collection)
5. Navigate to email verification screen
```

### Login Flow

```dart
1. User enters email and password
2. Sign in with Firebase Auth
3. Check if email is verified
4. If not verified, show verification screen
5. If verified, fetch user data from Firestore
6. Update lastSeen timestamp
7. Navigate to home
```

### Password Reset Flow

```dart
1. User enters email
2. Send password reset email via Firebase Auth
3. Show success message
4. User clicks link in email
5. Reset password
6. Auto-login or redirect to login
```

---

## üîÑ Real-time Listeners

### Notes Listener

```dart
// Listen to user's notes
Stream<List<Note>> watchUserNotes(String userId) {
  return firestore
    .collection('notes')
    .where('userId', isEqualTo: userId)
    .where('isArchived', isEqualTo: false)
    .orderBy('updatedAt', descending: true)
    .snapshots()
    .map((snapshot) => snapshot.docs
      .map((doc) => Note.fromJson(doc.data()))
      .toList());
}
```

### Shared Notes Listener

```dart
// Listen to notes shared with user
Stream<List<SharedNote>> watchSharedNotes(String userId) {
  return firestore
    .collection('shared_notes')
    .where('sharedWithId', isEqualTo: userId)
    .where('isActive', isEqualTo: true)
    .orderBy('sharedAt', descending: true)
    .snapshots()
    .map((snapshot) => snapshot.docs
      .map((doc) => SharedNote.fromJson(doc.data()))
      .toList());
}
```

### Messages Listener

```dart
// Listen to messages for a conversation
Stream<List<Message>> watchMessages(String userId, String otherUserId) {
  final conversationId = _getConversationId(userId, otherUserId);
  return firestore
    .collection('messages')
    .where('conversationId', isEqualTo: conversationId)
    .orderBy('createdAt', descending: false)
    .snapshots()
    .map((snapshot) => snapshot.docs
      .map((doc) => Message.fromJson(doc.data()))
      .toList());
}
```

---

## üì± Cloud Messaging Setup

### FCM Token Management

```dart
// Save FCM token to user document
Future<void> saveFcmToken(String userId, String token) async {
  await firestore
    .collection('users')
    .doc(userId)
    .update({'fcmToken': token});
}
```

### Notification Types

1. **Note Shared:** When someone shares a note with you
2. **Note Updated:** When a shared note is updated
3. **Message Received:** When you receive a new message
4. **PDF Generated:** When PDF generation is complete

### Notification Payload Structure

```json
{
  "notification": {
    "title": "New Note Shared",
    "body": "John Doe shared 'Meeting Notes' with you"
  },
  "data": {
    "type": "note_shared",
    "noteId": "note123",
    "action": "open_note"
  }
}
```

---

## üìä Indexes Required

Create these composite indexes in Firestore Console:

1. **notes:**

   - `userId` (Ascending) + `createdAt` (Descending)
   - `userId` (Ascending) + `updatedAt` (Descending)
   - `userId` (Ascending) + `isArchived` (Ascending) + `createdAt` (Descending)
   - `userId` (Ascending) + `category` (Ascending) + `createdAt` (Descending)

2. **shared_notes:**

   - `sharedWithId` (Ascending) + `isActive` (Ascending) + `sharedAt` (Descending)
   - `ownerId` (Ascending) + `isActive` (Ascending) + `sharedAt` (Descending)
   - `noteId` (Ascending) + `isActive` (Ascending)

3. **messages:**
   - `receiverId` (Ascending) + `isRead` (Ascending) + `createdAt` (Descending)
   - `senderId` (Ascending) + `createdAt` (Descending)
   - `noteId` (Ascending) + `createdAt` (Descending)

---

## ‚úÖ Best Practices

1. **Denormalization:** Store frequently accessed data (like note title in shared_notes) for performance
2. **Indexes:** Create indexes before deploying to production
3. **Security Rules:** Test rules thoroughly before deployment
4. **Real-time Updates:** Use streams for real-time data
5. **Pagination:** Implement pagination for large collections
6. **Error Handling:** Handle Firestore errors gracefully
7. **Offline Support:** Firestore automatically caches data for offline access

---

This Firebase architecture ensures:

- ‚úÖ Secure data access
- ‚úÖ Real-time synchronization
- ‚úÖ Scalable structure
- ‚úÖ Efficient queries
- ‚úÖ Proper indexing

Follow this structure for all Firebase operations! üî•
